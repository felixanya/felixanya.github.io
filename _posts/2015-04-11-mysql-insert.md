---
layout: post
title: "浅淡分区游戏的数据合服"
description: ""
category: 
tags: []
intro: "浅淡分区游戏的数据合服"
---

## 浅淡分区游戏的数据合服

手机游戏或者页游的一个服的数据非常之大，一般数据有几亿条.那么要几个游戏服的数据合并在一个服上，可想数据非常之大。
一般游戏合服的规则都是多少天没有登陆过，没有充值过或者角色等级小于多少就不要这些角色。但这样对于玩家来说多多少少会
损失，但必竞争老服才这样。本次不在讨论范围。目前有两种数据做法，一是数据不合并，所有游戏的数据都放在数据库集群里，把数据
都按一定规则分库，分表。而数据在组合在一起就直接按一定的规则去读取这些数据便可。另一种方法就是一个区服对应一个数据。本章节
所说的就是后面的情况。那么几个区服要合并数据，必须是要抽取数据合并在一个新的数据里，咋样的方法才让这种合并数据更快。以前
我们的做法是用php来实现，首先要读取合服前的数据，把要合服的用户信息重新分配用户角色ID，当然也要处理名字冲突和军团名字冲突等待，
当然前面所说到的按规则处理就不用这么麻烦一开始就分配好是几区的数据了。而现在要把这样的数据取出来后，再重新插入回原数据库。
这样要程序上也要处理所有的游戏逻辑上的东西，也要处理数据库上的东西。每次合服，特别是数据量非常大和多个服合在一起的时候变得非常慢，
至少要合半天或以上，因为PHP只能单线程处理这样的事，而mysql也不能更好的控制。所以这两天用另一个程序重新写了一个程序。
拿某些数据量非常的表来测试，速度非常快，三个服的数据合在一起只用了半小时。

## 具体实现

首先把所有的数据都处理好，尽量所有的数据只有Insert。向表里插入数据要求是批量插入，多进程同时完成插入操作
当然在大并发插入下mysql可能会报 Buffer Busy


充分利用linux下的多核，所以cpu可能去到百分之300，或百合之500以上

![linux_cpu_1 images](http://felixanya.github.com/img/linux_cpu_1.jpg)

![linux_cpu_2 images](http://felixanya.github.com/img/linux_cpu_2.jpg)


让mysql多线程操作，连接数开大点

![myql images](http://felixanya.github.com/img/mysql_stats.png)

具体的程序过程

![run images](http://felixanya.github.com/img/go_run.png)